<!doctype html>
<html>
  <head>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@600;700;800&display=swap" rel="stylesheet">
    <title>TECHNICIAN / VENDOR â€¢ SECURE ENTRY</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
    <link rel="dns-prefetch" href="//cdn.jsdelivr.net">

    <style>


    .fixed-header{

      position: fixed;

      top: 0;

      left: 0;

      width: 100%;

      background: #e9f5e9;

      z-index: 9999;

      padding: 14px 0 10px 0;

      box-shadow: 0 2px 8px rgba(0,0,0,.08);

    }


    .header-inner{

      max-width: 420px;

      margin: 0 auto;

      text-align: center;

      padding: 0 20px;

    }

    .header-line{

      height:3px;

      width:60px;

      margin:0 auto 4px auto;

      background:linear-gradient(90deg,#3bd97b 20%,#2b7a2b 80%);

      border-radius:2px;

    }


    body{

      margin:0;

      font-family: Arial, sans-serif;

      background:#e9f5e9;

      text-transform: uppercase;

      padding: 0 20px 20px 20px;

    }


    h2 {

        color: #2b7a2b;

        text-align: center;

        margin-top: 0.10px;

        margin-bottom: 30px;

      }

      .clock-bar {

        display: flex;

        justify-content: space-between;

        align-items: center;

        width: 100%;

        max-width: 180px;

        margin: 0 auto 10px auto;

        padding: 2.5px 12px;

        border-radius: 11px;

        background: linear-gradient(90deg, #41e671 0%, #176B39 100%);

        box-shadow: 0 1px 4px 0 #bbdfbb70;

        font-size: 11px;

        color: #fff;

        letter-spacing: 1.4px;

        font-family: Arial, sans-serif;

        font-weight: bold;

        opacity: 0.90;

        position: relative;

        z-index: 10;

      }

      .clock-date, .clock-time {

        font-size: 11px;

      }

      .header-gradient {

        font-family: 'Orbitron', Arial, sans-serif;

        background: linear-gradient(145deg, #54e087 0%, #2b7a2b 100%);

        font-weight: 900;

        font-size: 1.6rem;

        letter-spacing: 1.3px;

        -webkit-background-clip: text;

        -webkit-text-fill-color: transparent;

        background-clip: text;

        color: transparent;

      }


      .swal2-popup {

        width: 300px !important;

        max-width: 300px !important;

        padding: 14px 16px !important;

        border-radius: 14px !important;

      }

      .swal2-title {

        margin: 0 0 6px 0 !important;

        font-size: 16px !important;

        font-weight: 900 !important;

        letter-spacing: 1.2px !important;

      }

      .swal2-html-container {

        margin: 0 !important;

        font-size: 13px !important;

        font-weight: bold !important;

        line-height: 1.35 !important;

        letter-spacing: 0.7px !important;

      }

      .swal2-actions {

        margin: 12px 0 0 0 !important;

        gap: 10px;

      }

      .swal2-confirm {

        background: linear-gradient(135deg, #2b7a2b 0%, #3bd97b 100%) !important;

        color: #fff !important;

        font-weight: bold !important;

        border: none !important;

        border-radius: 10px !important;

        box-shadow: 0 3px 12px 0 #bbdfbb, 0 1.5px 3px #3333 !important;

        letter-spacing: 1.6px;

        padding: 10px 22px !important;

        font-size: 14px !important;

        transition: box-shadow 0.16s, transform 0.09s;

      }

      .swal2-confirm:active {

        box-shadow: 0 2px 5px #bbb !important;

        transform: translateY(2px);

      }

      .swal2-cancel {

        background: linear-gradient(135deg, #e52d27 0%, #ff5757 100%) !important;

        color: #fff !important;

        font-weight: bold !important;

        border: none !important;

        border-radius: 10px !important;

        box-shadow: 0 3px 10px #ffd2d2b9, 0 1.5px 3px #3333 !important;

        letter-spacing: 1.6px;

        padding: 10px 22px !important;

        font-size: 14px !important;

        margin-left: 0 !important;

        transition: box-shadow 0.16s, transform 0.09s;

      }

      .swal2-cancel:active {

        box-shadow: 0 2px 6px #d8b !important;

        transform: translateY(2px);

      }


    .top-action {

        text-align: center;

        margin-bottom: 14px;

      }

      .btn-3d {

        background: linear-gradient(145deg, #3bd97b 0%, #2b7a2b 100%);

        color: #fff;

        border: none;

        border-radius: 10px;

        font-size: 14px;

        font-weight: bold;

        padding: 10px 22px;

        box-shadow: 0 3px 12px 0 #bbdfbb, 0 1.5px 3px #3333;

        letter-spacing: 1.6px;

        cursor: pointer;

        margin-bottom: 5px;

        transition: box-shadow 0.18s, transform 0.1s;

      }

      .btn-3d:active {

        box-shadow: 0 2px 5px #bbb;

        transform: translateY(2px);

      }

      .submit-3d {

        margin-top: 14px;

        width: 100%;

      }


      .photo-label {

        color: #2b7a2b;

        font-weight: bold;

        font-size: 13px;

        margin-top: 4px;

        margin-bottom: 3px;

        display: block;

      }


      .image-container {

        position: relative;

        display: none;

        margin-top: 10px;

        margin-bottom: 12px;

        width: 100%;

        max-height: 220px;

        overflow: hidden;

        background-color: #f0f0f0;

        border: 1px solid #2b7a2b;

        border-radius: 6px;

      }

      .image-container img {

        width: 100%;

        height: auto;

        object-fit: cover;

        transform-origin: center;

      }

      .watermark {

        position: absolute;

        left: 50%;

        top: 50%;

        transform: translate(-50%, -50%) rotate(-40deg);

        color: red;

        background: none;

        padding: 4px 20px;

        font-size: 11px;

        font-family: Arial, sans-serif;

        font-weight: bold;

        border-radius: 4px;

        pointer-events: none;

        letter-spacing: 4px;

        opacity: 0.75;

        text-shadow: none;

        z-index: 9;

        white-space: nowrap;

      }


      label {

        display: block;

        margin-top: 10px;

        color: #2b7a2b;

        font-weight: bold;

        font-size: 13px;

      }

      input,

      select {

        width: 100%;

        padding: 7px 9px;

        margin-top: 4px;

        border: 1px solid #2b7a2b;

        border-radius: 8px;

        text-transform: uppercase;

        background-color: #e9f7ff;

        box-sizing: border-box;

        font-family: Arial, sans-serif;

        font-size: 13px;

        font-weight: bold;

      }


      select:invalid,

      select option[value=""] {

        color: #888888 !important;

      }


      .reason-placeholder {

      color: #888888 !important;

      }

      #reasonSelect {

      color: #888888;

      }


      .phone-container {

        position: relative;

        margin-bottom: 20px;

        display: flex;

        align-items: center;

      }

      .phone-container input {

        flex: 1;

        margin-right: 6px;

      }

      .call-btn-3d {

        display: none;

        background: linear-gradient(145deg, #41e671 0%, #176B39 100%);

        color: #fff;

        border: none;

        border-radius: 100%;

        width: 50px;

        height: 50px;

        font-size: 17px;

        font-weight: bold;

        box-shadow: 0 3px 10px #8ed5a3, 0 1.5px 3px #3333;

        justify-content: center;

        align-items: center;

        cursor: pointer;

        transition: box-shadow 0.18s, transform 0.1s;

        position: relative;

        margin-left: 5px;

        outline: none;

        text-decoration: none;

      }

      .call-btn-3d span {

        font-size: 15px;

        font-family: Arial, sans-serif;

        font-weight: bold;

        letter-spacing: 1.5px;

        color: #fff;

      }

      .call-btn-3d:active {

        box-shadow: 0 2px 5px #bbb;

        transform: translateY(2px) scale(0.98);

      }


      .footer {

      position: fixed;

      bottom: 8px;

      left: 0;

      width: 100%;

      text-align: center;

      font-size: 10px;

      color: #9aa9a0;

      font-family: Arial, sans-serif;

      font-weight: bold;

      pointer-events: none;

    }


      .camera-modal {

        position: fixed;

        top: 0;

        left: 0;

        width: 100vw;

        height: 100vh;

        background: rgba(0,0,0,0.85);

        z-index: 99999;

        display: flex;

        justify-content: center;

        align-items: center;

        flex-direction: column;

      }

      .camera-container {

        position: relative;

        width: 94vw;

        max-width: 400px;

        aspect-ratio: 4/3;

        background: #000;

        border-radius: 14px;

        overflow: hidden;

      }

      #camera-video {

        width: 100%;

        height: auto;

        border-radius: 14px;

        background: #222;

      }

      .guideline {

        position: absolute;

        border: 3px solid #28cc6c;

        border-radius: 8px;

        left: 4%;

        top: 4%;

        width: 92%;

        height: 92%;

        pointer-events: none;

        box-sizing: border-box;

      }

      .close-cam-btn {

        position: absolute;

        top: 10px;

        right: 13px;

        z-index: 100;

        background: #fff;

        color: #1c7e41;

        border: none;

        border-radius: 24px;

        font-size: 21px;

        padding: 4px 13px;

        font-weight: bold;

        cursor: pointer;

        box-shadow: 0 2px 10px #aaa;

      }

      .capture-btn-3d {

        display: flex;

        justify-content: center;

        align-items: center;

        background: linear-gradient(145deg, #41e671 0%, #176B39 100%);

        color: #fff;

        border: none;

        border-radius: 100%;

        width: 60px;

        height: 60px;

        font-size: 17px;

        font-family: Arial, sans-serif;

        font-weight: bold;

        box-shadow: 0 3px 10px #8ed5a3, 0 1.5px 3px #3333;

        letter-spacing: 1.5px;

        cursor: pointer;

        transition: box-shadow 0.18s, transform 0.1s;

        margin-top: 16px;

      }

      .capture-btn-3d:active {

        box-shadow: 0 2px 5px #bbb;

        transform: translateY(2px) scale(0.98);

      }

      @media (max-width: 500px) {

        .camera-container { max-width: 98vw; }

      }

      .spinner,

      .loader {

        display: inline-block;

        width: 18px;

        height: 18px;

        border-radius: 50%;

        box-sizing: border-box;


        border: 3px solid rgba(255, 255, 255, 0.25);

        border-top-color: #ffffff;

        border-right-color: #ffffff;

        border-bottom-color: rgba(255, 255, 255, 0.1);

        border-left-color: rgba(255, 255, 255, 0.1);

        animation: google-spin 0.8s linear infinite;

        vertical-align: middle;

        margin-right: 8px;

      }


      @keyframes google-spin {

        0%   { transform: rotate(0deg); }

        50%  { transform: rotate(180deg); }

        100% { transform: rotate(360deg); }

      }


    .ocr-panel{

      position:absolute;

      left:10px;

      bottom:10px;

      z-index:60;

      pointer-events:none;

      user-select:none;

    }


    .ocr-item{

      display:flex;

      align-items:center;

      gap:8px;

      margin:5px 0;

      font-size:10px;

      font-weight:700;

      letter-spacing:.6px;

      text-transform:uppercase;

    }


    .ocr-item .dot{

      width:12px;

      height:12px;

      border-radius:50%;

      display:inline-block;

    }


    .ocr-item.bad{ color:#ff3b3b; }

    .ocr-item.bad .dot{ background:#ff3b3b; box-shadow:0 0 12px rgba(255,59,59,.65); }


    .ocr-item.good{ color:#16c172; }

    .ocr-item.good .dot{ background:#16c172; box-shadow:0 0 12px rgba(22,193,114,.85); }


    .guideline.ocr-ready{

      animation: ocrGoogleBorder 1.4s linear infinite, ocrGlow 0.8s ease-in-out infinite alternate;

    }


    @keyframes ocrGoogleBorder{

      0%   { border-color:#34A853; }

      25%  { border-color:#FBBC05; }

      50%  { border-color:#4285F4; }

      75%  { border-color:#EA4335; }

      100% { border-color:#34A853; }

    }

    @keyframes ocrGlow{

      0%   { box-shadow: 0 0 0 rgba(0,0,0,0); }

      100% { box-shadow: 0 0 26px rgba(255,255,255,.35); }

    }


    .camera-wrap{

      position: relative;

      display: flex;

      flex-direction: column;

      align-items: center;

    }


    #ocrLivePanel.ocr-panel{

      position: absolute !important;

      left: 12px !important;

      top: calc(100% - 60px) !important;

      z-index: 9999;

      pointer-events: none;

      user-select: none;

    }


    .ocr-title{

      font-size: 11px;

      font-weight: 900;

      letter-spacing: 1px;

      margin-bottom: 6px;

      color: #ffffff;

      text-shadow: 0 1px 6px rgba(0,0,0,.55);

    }


    .camera-wrap .capture-btn-3d{

      position: static !important;

      margin-top: 14px;

      z-index: 999999;

    }


    #cameraModal .capture-btn-3d{

      position: static !important;

      left: auto !important;

      bottom: auto !important;

      transform: none !important;

    }


    .search-minicard {

        max-width: 330px;

        margin: 18px auto 22px auto;

        background: #fff;

        border-radius: 13px;

        box-shadow: 0 2px 8px #176b3917;

        padding: 12px 15px 16px 15px;

      }

      .search-mini-title {

        display: flex;

        align-items: center;

        justify-content: center;

        margin-bottom: 9px;

        font-size: 15px;

        font-weight: bold;

        color: #176B39;

        letter-spacing: 1px;

      }

      .search-emoji {

        margin-right: 7px;

        font-size: 1.18em;

      }

      .search-mini-input {

        width: 100%;

        padding: 6.5px 10px;

        font-size: 14px;

        border-radius: 7px;

        border: 1.5px solid #176B39;

        margin-bottom: 9px;

        font-weight: 500;

        background: #e9f7ff;

        box-sizing: border-box;

        transition: border 0.15s;

      }

      .search-mini-input:focus {

        border: 1.6px solid #3bd97b;

        background: #f6fff6;

        outline: none;

      }

      .search-mini-btn {

        width: 100%;

        font-size: 16px;

        padding-top: 10px;

        padding-bottom: 10px;

        margin: 0 auto;

        box-sizing: border-box;

      }

      @media (max-width: 500px) {

        .search-minicard {

          max-width: 97vw;

          padding: 9px 4vw 12px 4vw;

        }

        .search-mini-title {

          font-size: 15px;

        }

        .search-mini-input {

          font-size: 13px;

          padding: 6px 7px;

        }

        .search-mini-btn {

          font-size: 13px;

          padding-top: 8px;

          padding-bottom: 8px;

        }

      }


/* === TECH/VENDOR module additions === */
.btn-3d-red{
  background: linear-gradient(135deg, #e52d27 0%, #ff5757 100%) !important;
  color:#fff !important;
  box-shadow: 0 3px 10px #ffd2d2b9, 0 1.5px 3px #3333 !important;
}
.btn-3d-red:active{
  box-shadow: 0 2px 6px #d8b !important;
  transform: translateY(2px);
}
.small-note{
  font-size: 11px;
  color: #489167;
  font-weight: bold;
  letter-spacing: .6px;
  margin-top: 6px;
  text-transform: uppercase;
}
.status-wrap{display:block; margin-top:10px;}

    </style>
  </head>

  <body>

    <div class="fixed-header">
      <div class="header-inner">
        <div class="clock-bar">
          <span id="liveDateOnly"></span>
          <span id="liveTimeOnly"></span>
        </div>

        <div style="text-align:center;margin-bottom:8px;">
          <h2 class="header-gradient" style="margin-bottom:0.18em;">
            TECHNICIAN / VENDOR
          </h2>
          <div style="color:#489167;font-size:13px;letter-spacing:0.6px;margin-bottom:6px;">
            REGISTER.ACCESS.SECURE
          </div>
        </div>

        <div class="header-line"></div>
      </div>
    </div>

    <div class="search-minicard">
      <div class="search-mini-title">
        <span class="search-emoji">ðŸ”Ž</span>
        <span>SEARCH RECORD</span>
      </div>
      <input id="searchUniversal" type="text" placeholder="MYKAD / PASSPORT / REG NO" autocomplete="off"
             class="search-mini-input" style="font-weight:bold;">
      <button id="searchButton" class="btn-3d search-mini-btn" type="button" onclick="handleUniversalSearch()">SEARCH</button>
    </div>

    <div class="top-action">
      <button type="button" id="takePhotoBtn" class="btn-3d" onclick="openCamera()">TAKE PICTURE</button>
      <span class="photo-label">Take photo (optional) â€¢ Watermark: SENSORY USE ONLY</span>
    </div>

    <div class="image-container" id="imageContainer">
      <img id="preview" src="#" alt="IMAGE PREVIEW">
      <div class="watermark">SENSORY USE ONLY</div>
    </div>

    <form id="registrationForm" autocomplete="off">

      <label for="companySelect">COMPANY</label>
      <select id="companySelect" name="companySelect" required>
        <option value="" disabled selected>-PLEASE SELECT-</option>
        <option value="TENAGA NASIONAL BERHAD (TNB)">TENAGA NASIONAL BERHAD (TNB)</option>
        <option value="SKA">SKA</option>
        <option value="HYUNDAI ELEVATOR">HYUNDAI ELEVATOR</option>
        <option value="MASTER POOL">MASTER POOL</option>
        <option value="TIME">TIME</option>
        <option value="TELEKOM MALAYSIA (TM)">TELEKOM MALAYSIA (TM)</option>
        <option value="U MOBILE">U MOBILE</option>
        <option value="OTHER">OTHER</option>
      </select>
      <input type="text" id="companyOther" name="companyOther" placeholder="PLEASE SPECIFY"
             style="display:none; margin-top:10px;">

      <label for="techCategorySelect">CATEGORY TECHNICIAN / VENDOR</label>
      <select id="techCategorySelect" name="techCategorySelect" required>
        <option value="" disabled selected>-PLEASE SELECT-</option>
        <option value="ACCESS CARD / CCTV">ACCESS CARD / CCTV</option>
        <option value="LIFT">LIFT</option>
        <option value="INTERNET">INTERNET</option>
        <option value="MAINTENANCE">MAINTENANCE</option>
        <option value="SERVICE">SERVICE</option>
        <option value="INSTALLATION">INSTALLATION</option>
        <option value="OTHER">OTHER</option>
      </select>
      <input type="text" id="techCategoryOther" name="techCategoryOther" placeholder="PLEASE SPECIFY"
             style="display:none; margin-top:10px;">

      <label for="namePassport">NAME</label>
      <input type="text" id="namePassport" name="namePassport" required>

      <label for="mykadPassport">MYKAD / PASSPORT</label>
      <input type="text" id="mykadPassport" name="mykadPassport" required>

      <label for="regnum">REGISTRATION NUMBER</label>
      <input type="text" id="regnum" name="regnum" required>

      <label for="contact">CONTACT NUMBER</label>
      <div class="phone-container">
        <input type="tel" id="contact" name="contact" required oninput="updateCallLink()"
               minlength="10" maxlength="15" autocomplete="off" inputmode="numeric" pattern="[0-9]{10,15}">
        <a id="callBtn" class="call-btn-3d" title="Call this number" style="display:none;" target="_blank">
          <span>ðŸ“ž</span>
        </a>
      </div>

      <label for="workLocation">WORK LOCATION</label>
      <input type="text" id="workLocation" name="workLocation" required
             placeholder="EXAMPLE: TOWER A LOBBY / UNIT A-09-03A">

      <label for="jobDescription">JOB DESCRIPTION</label>
      <input type="text" id="jobDescription" name="jobDescription" required
             placeholder="EXAMPLE: REPAIR LIFT / TEST FIRE ALARM">


      <div id="statusWrap" class="status-wrap" style="display:block;">
        <label for="statusSelect">JOB STATUS</label>
        <select id="statusSelect" name="statusSelect" disabled>
          <option value="" disabled selected>-PLEASE SELECT-</option>
          <option value="COMPLETED">COMPLETED</option>
          <option value="RETURN REQUIRED">RETURN REQUIRED</option>
          <option value="MONITORING REQUIRED">MONITORING REQUIRED</option>
        </select>

        <input type="text" id="statusSpecify" name="statusSpecify" placeholder="PLEASE SPECIFY"
               style="display:none; margin-top:10px;" />

        <div class="small-note">Status will be enabled during CHECK OUT.</div>
      </div>


      <input type="file" accept="image/*" capture="environment" id="imageInput" style="display:none;">

      <button type="submit" class="btn-3d submit-3d" id="submitBtn">SUBMIT</button>
      <button type="button" class="btn-3d submit-3d btn-3d-red" id="checkoutBtn" disabled>CHECK OUT</button>

    </form>

    <div class="footer">POWERED BY MRED TECH</div>

    <div id="cameraModal" class="camera-modal" style="display:none;">
      <div class="camera-wrap">
        <div class="camera-container">
          <video id="camera-video" autoplay playsinline></video>
          <div class="guideline" id="ocrGuideline"></div>
          <canvas id="ocrProbe" width="320" height="240" style="display:none;"></canvas>
          <button class="close-cam-btn" type="button" onclick="closeCameraModal()">Ã—</button>
        </div>

        <div id="ocrLivePanel" class="ocr-panel">
          <div class="ocr-title">OCR QUALITY</div>
          <div class="ocr-item bad" data-key="sharp"><span class="dot"></span><span>SHARPNESS</span></div>
          <div class="ocr-item bad" data-key="stable"><span class="dot"></span><span>STABILITY</span></div>
          <div class="ocr-item bad" data-key="light"><span class="dot"></span><span>LIGHTING</span></div>
          <div class="ocr-item bad" data-key="contrast"><span class="dot"></span><span>CONTRAST</span></div>
          <div class="ocr-item bad" data-key="glare"><span class="dot"></span><span>GLARE / SHADOW</span></div>
          <div class="ocr-item bad" data-key="clarity"><span class="dot"></span><span>CLARITY</span></div>
        </div>

        <button type="button" class="capture-btn-3d" onclick="captureImage()"></button>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
/* ==================================================
   TECHNICIAN / VENDOR (Secure Entry Style)
================================================== */

const WORKER_URL = "https://ext-mredtech.edreborn86.workers.dev";

const PREVIEW_MAX_RATIO = 0.70;
const CAPTURE_MAX_W = 1100;
const CAPTURE_JPEG_Q = 0.75;

const FIELD = {
  REG: "REGNUM",
  ID: "MYKADPASSPORT"
};

const OCR_LIVE = {
  running: false,
  rafId: null,
  lastTick: 0,
  TH: {
    sharpness: 90,
    contrast: 30,
    brightnessMin: 70,
    brightnessMax: 210,
    stabilityAvgDiff: 7.5,
    glareWhitePct: 0.04,
    shadowBlackPct: 0.14
  }
};

// DOM
const companySelect = document.getElementById('companySelect');
const companyOther  = document.getElementById('companyOther');
const techCatSelect = document.getElementById('techCategorySelect');
const techCatOther  = document.getElementById('techCategoryOther');

const previewImg     = document.getElementById('preview');
const imageContainer = document.getElementById('imageContainer');
const watermarkOverlay = document.querySelector('#imageContainer .watermark');

const statusWrap   = document.getElementById('statusWrap');
const statusSelect = document.getElementById(\'statusSelect\');
const statusSpecify = document.getElementById(\'statusSpecify\');
const checkoutBtn = document.getElementById('checkoutBtn');

let stream = null;
let video  = null;

let __SE_SUBMIT_PHOTO = "";
let __SE_OCR_PHOTO = "";
let __TV_RECORD_ID = "";

const __SE_CAPTURE = (() => {
  const scaled = document.createElement('canvas');
  const finalC = document.createElement('canvas');
  const ctxScaled = scaled.getContext('2d', { willReadFrequently: false });
  const ctxFinal  = finalC.getContext('2d', { willReadFrequently: true });

  function ensureSize(c, w, h){
    if (c.width !== w) c.width = w;
    if (c.height !== h) c.height = h;
  }

  return { scaled, final: finalC, ctxScaled, ctxFinal, ensureSize };
})();

// helpers
function clamp01(n){ return Math.max(0, Math.min(1, n)); }
function normalize(str) {
  return (str || '').toUpperCase().replace(/[^A-Z0-9]/g, '');
}
function normUpper(str) {
  return (str || '').toString().trim().toUpperCase();
}
function safeSwalFire(options) {
  if (typeof Swal !== "undefined") return Swal.fire(options);
  alert((options.title || "NOTICE") + "\n\n" + (options.text || ""));
  return Promise.resolve({ isConfirmed: true });
}
function setSubmitBtnLoading(isLoading) {
  const btn = document.getElementById('submitBtn');
  if (!btn) return;
  if (isLoading) {
    btn.disabled = true;
    btn.innerHTML = `<span class="spinner"></span>SUBMITTING...`;
  } else {
    btn.disabled = false;
    btn.innerHTML = `SUBMIT`;
  }
}
function setCheckoutBtnLoading(isLoading) {
  if (!checkoutBtn) return;
  if (isLoading) {
    checkoutBtn.disabled = true;
    checkoutBtn.innerHTML = `<span class="spinner"></span>CHECKING OUT...`;
  } else {
    checkoutBtn.innerHTML = `CHECK OUT`;
    checkoutBtn.disabled = !__TV_RECORD_ID;
  }
}
function setPreviewOnly(dataUrl){
  if (!previewImg) return;
  previewImg.src = dataUrl;
  if (imageContainer) imageContainer.style.display = 'block';
}
function drawWatermarkOnCanvas(ctx, w, h){
  const text = "SENSORY USE ONLY";
  ctx.save();
  ctx.translate(w * 0.5, h * 0.5);
  ctx.rotate(-40 * Math.PI / 180);
  ctx.globalAlpha = 0.75;
  ctx.fillStyle = "red";
  ctx.font = "bold 14px Arial, sans-serif";
  ctx.textAlign = "center";
  ctx.textBaseline = "middle";

  const letters = text.split("");
  const spacing = 4;
  let totalW = 0;
  const metrics = letters.map(ch => {
    const m = ctx.measureText(ch).width;
    totalW += m;
    return m;
  });
  totalW += spacing * (letters.length - 1);

  let x = -totalW / 2;
  for (let i=0;i<letters.length;i++){
    ctx.fillText(letters[i], x + metrics[i]/2, 0);
    x += metrics[i] + spacing;
  }
  ctx.restore();
}
function applyGrayscaleContrast(canvas, ctx) {
  const width = canvas.width;
  const height = canvas.height;
  const imageData = ctx.getImageData(0, 0, width, height);
  const data = imageData.data;

  let minL = 255;
  let maxL = 0;

  for (let i = 0; i < data.length; i += 4) {
    const r   = data[i];
    const g   = data[i + 1];
    const b   = data[i + 2];
    const lum = 0.299 * r + 0.587 * g + 0.114 * b;

    if (lum < minL) minL = lum;
    if (lum > maxL) maxL = lum;

    data[i] = data[i + 1] = data[i + 2] = lum;
  }

  const range = Math.max(1, maxL - minL);

  for (let i = 0; i < data.length; i += 4) {
    let lum       = data[i];
    let stretched = ((lum - minL) * 255) / range;
    stretched     = Math.max(0, Math.min(255, stretched));
    data[i] = data[i + 1] = data[i + 2] = stretched;
  }

  ctx.putImageData(imageData, 0, 0);
}
function nowStamp(){
  const d = new Date();
  const pad = (n)=> String(n).padStart(2,'0');
  return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
}

// Others logic
function syncOthersLogic(){
  const c = companySelect.value;
  companyOther.style.display = (c === "OTHER") ? "block" : "none";
  companyOther.required = (c === "OTHER");
  if (c !== "OTHER") companyOther.value = "";

  const t = techCatSelect.value;
  techCatOther.style.display = (t === "OTHER") ? "block" : "none";
  techCatOther.required = (t === "OTHER");
  if (t !== "OTHER") techCatOther.value = "";
}
companySelect.addEventListener("change", syncOthersLogic);
techCatSelect.addEventListener("change", syncOthersLogic);
syncOthersLogic();

// Status specify logic
function syncStatusSpecify(){
  const v = (statusSelect?.value || "");
  const need = (v === "RETURN REQUIRED");
  if (statusSpecify){
    statusSpecify.style.display = need ? "block" : "none";
    statusSpecify.required = need && !statusSelect.disabled;
    if (!need) statusSpecify.value = "";
  }
}
if (statusSelect){
  statusSelect.addEventListener("change", syncStatusSpecify);
}
if (statusSpecify){
  statusSpecify.addEventListener("input", ()=>{ statusSpecify.value = normUpper(statusSpecify.value); });
}
syncStatusSpecify();


// Uppercase
["namePassport","regnum","workLocation","jobDescription","companyOther","techCategoryOther"].forEach(id=>{
  const el = document.getElementById(id);
  if (el) el.addEventListener("input", ()=> el.value = normUpper(el.value));
});

// Mykad auto dash + validate
(function attachMykadAutoDash(){
  const mykadInput = document.getElementById('mykadPassport');
  if (!mykadInput) return;

  mykadInput.addEventListener('input', function () {
    const raw = (this.value || '').toUpperCase().trim();
    const alnum = raw.replace(/[^A-Z0-9]/g, '');
    const hasLetter = /[A-Z]/.test(alnum);
    const digits = alnum.replace(/[^0-9]/g, '');

    if (!hasLetter && digits.length === 12) {
      this.value = digits.replace(/(\d{6})(\d{2})(\d{4})/, "$1-$2-$3");
    } else {
      this.value = alnum;
    }
    validateMykadPassport();
  });
})();

function validateMykadPassport() {
  const el = document.getElementById('mykadPassport');
  if (!el) return true;

  const raw = (el.value || '').toUpperCase().trim();
  if (!raw) {
    el.setCustomValidity('');
    return true;
  }

  const alnum = raw.replace(/[^A-Z0-9]/g, '');
  const hasLetter = /[A-Z]/.test(alnum);

  if (hasLetter) {
    el.setCustomValidity('');
    return true;
  }

  const digits = alnum.replace(/[^0-9]/g, '');
  if (digits.length !== 12) {
    el.setCustomValidity('Mykad 12 digit required');
    return false;
  }

  el.setCustomValidity('');
  return true;
}

// Camera + OCR panel (reused from Secure Entry - compact)
function openCamera() {
  document.getElementById('cameraModal').style.display = 'flex';
  startCamera();
}
async function startCamera() {
  video = document.getElementById('camera-video');
  try {
    stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
    video.srcObject = stream;
    await video.play().catch(() => {});
    startOcrLive();
  } catch (e) {
    alert("Failed to open camera: " + e.message);
    closeCameraModal();
  }
}
function closeCameraModal() {
  document.getElementById('cameraModal').style.display = 'none';
  stopOcrLive();
  if (stream) {
    stream.getTracks().forEach(track => track.stop());
    stream = null;
  }
}

function setOcrItem(key, ok){
  const el = document.querySelector(`#ocrLivePanel .ocr-item[data-key="${key}"]`);
  if (!el) return;
  el.classList.toggle("good", !!ok);
  el.classList.toggle("bad", !ok);
}
function calcStats(gray){
  let sum = 0, sum2 = 0;
  const n = gray.length;
  for (let i=0;i<n;i++){ const v=gray[i]; sum+=v; sum2+=v*v; }
  const mean = sum / n;
  const variance = (sum2 / n) - (mean*mean);
  const std = Math.sqrt(Math.max(0, variance));
  return { mean, std };
}
function calcSharpness(gray, w, h){
  let sum = 0, sum2 = 0, n = 0;
  for (let y = 1; y < h-1; y++) {
    const row = y*w;
    for (let x = 1; x < w-1; x++) {
      const i = row + x;
      const lap = (4*gray[i] - gray[i-1] - gray[i+1] - gray[i-w] - gray[i+w]);
      sum += lap; sum2 += lap*lap; n++;
    }
  }
  const mean = sum / n;
  const variance = (sum2 / n) - (mean*mean);
  return variance;
}
function getGrayFrame(videoEl, canvasEl){
  const ctx = canvasEl.getContext("2d", { willReadFrequently: true });
  const w = canvasEl.width, h = canvasEl.height;
  ctx.drawImage(videoEl, 0, 0, w, h);
  const data = ctx.getImageData(0, 0, w, h).data;
  const gray = new Uint8Array(w*h);
  for (let i=0, p=0; i<data.length; i+=4, p++) {
    const r=data[i], g=data[i+1], b=data[i+2];
    gray[p] = (0.2126*r + 0.7152*g + 0.0722*b) | 0;
  }
  return { gray, w, h };
}
function pctExtreme(gray, mode){
  let c=0; const n=gray.length;
  const WHITE_T=220, BLACK_T=18;
  for (let i=0;i<n;i++) {
    const v=gray[i];
    if (mode==="white" && v>=WHITE_T) c++;
    if (mode==="black" && v<=BLACK_T) c++;
  }
  return c/n;
}
function hasWhiteCluster(gray, w, h){
  const WHITE_T=215;
  const MIN_CLUSTER = Math.floor(w*h*0.008);
  let run=0;
  for (let i=0;i<gray.length;i+=2) {
    if (gray[i] >= WHITE_T) {
      run++;
      if (run >= MIN_CLUSTER) return true;
    } else run=0;
  }
  return false;
}
let lastFrameGray=null;
function calcStability(gray){
  if (!lastFrameGray) {
    lastFrameGray=new Uint8Array(gray.length);
    lastFrameGray.set(gray);
    return false;
  }
  let diff=0, samples=0;
  for (let i=0;i<gray.length;i+=30){ diff += Math.abs(gray[i]-lastFrameGray[i]); samples++; }
  lastFrameGray.set(gray);
  const avgDiff=diff/Math.max(1,samples);
  return avgDiff <= OCR_LIVE.TH.stabilityAvgDiff;
}
function startOcrLive(){
  const videoEl=document.getElementById("camera-video");
  const canvasEl=document.getElementById("ocrProbe");
  const guidelineEl=document.getElementById("ocrGuideline");
  if (!videoEl || !canvasEl) return;

  OCR_LIVE.running=true;
  OCR_LIVE.lastTick=0;
  ["sharp","stable","light","contrast","glare","clarity"].forEach(k=>setOcrItem(k,false));
  lastFrameGray=null;
  if (guidelineEl) guidelineEl.classList.remove("ocr-ready");

  const loop=()=>{
    if (!OCR_LIVE.running) return;
    const now=performance.now();
    if (now - OCR_LIVE.lastTick < 90) {
      OCR_LIVE.rafId=requestAnimationFrame(loop);
      return;
    }
    OCR_LIVE.lastTick=now;

    if (videoEl.readyState>=2 && !videoEl.paused && !videoEl.ended) {
      const {gray,w,h}=getGrayFrame(videoEl, canvasEl);
      const sharp=calcSharpness(gray,w,h);
      const {mean,std}=calcStats(gray);

      const okSharp = sharp >= OCR_LIVE.TH.sharpness;
      const okStable = calcStability(gray);
      const okLight = (mean >= OCR_LIVE.TH.brightnessMin) && (mean <= OCR_LIVE.TH.brightnessMax);
      const okContrast = std >= OCR_LIVE.TH.contrast;

      const glarePct = pctExtreme(gray,"white");
      const shadowPct = pctExtreme(gray,"black");
      const hasCluster = hasWhiteCluster(gray,w,h);

      const okGlare = (glarePct < OCR_LIVE.TH.glareWhitePct) &&
                      (shadowPct < OCR_LIVE.TH.shadowBlackPct) &&
                      !hasCluster;

      const okClarity = okSharp && okStable && okLight && okContrast && okGlare;

      setOcrItem("sharp", okSharp);
      setOcrItem("stable", okStable);
      setOcrItem("light", okLight);
      setOcrItem("contrast", okContrast);
      setOcrItem("glare", okGlare);
      setOcrItem("clarity", okClarity);

      const allGreen = okSharp && okStable && okLight && okContrast && okGlare && okClarity;
      if (guidelineEl) guidelineEl.classList.toggle("ocr-ready", allGreen);
    }
    OCR_LIVE.rafId=requestAnimationFrame(loop);
  };
  if (OCR_LIVE.rafId) cancelAnimationFrame(OCR_LIVE.rafId);
  OCR_LIVE.rafId=requestAnimationFrame(loop);
}
function stopOcrLive(){
  OCR_LIVE.running=false;
  if (OCR_LIVE.rafId) cancelAnimationFrame(OCR_LIVE.rafId);
  OCR_LIVE.rafId=null;
  const guidelineEl=document.getElementById("ocrGuideline");
  if (guidelineEl) guidelineEl.classList.remove("ocr-ready");
  ["sharp","stable","light","contrast","glare","clarity"].forEach(k=>setOcrItem(k,false));
}

// Capture pipeline
function getGuidelineCropRatios(){
  const container=document.querySelector('.camera-container');
  const guideline=document.querySelector('.guideline');
  const videoEl=document.getElementById('camera-video');
  if (!container || !guideline || !videoEl) return null;

  const g=guideline.getBoundingClientRect();
  let vRect=videoEl.getBoundingClientRect();
  if (!vRect || vRect.width<2 || vRect.height<2) vRect = container.getBoundingClientRect();

  const left = clamp01((g.left - vRect.left)/vRect.width);
  const top  = clamp01((g.top - vRect.top)/vRect.height);
  const w    = clamp01(g.width/vRect.width);
  const h    = clamp01(g.height/vRect.height);
  return {left, top, w, h};
}

function buildFinalImageFromSourceCrop(drawSourceCropFn, options){
  options = options || {};
  const burnInWatermark = options.burnInWatermark !== false;

  const info = drawSourceCropFn();
  if (!info || !info.outW || !info.outH) return "";

  const outW=info.outW, outH=info.outH;
  const maxH=Math.max(1, Math.round(outW*PREVIEW_MAX_RATIO));
  const finalH=Math.min(outH, maxH);

  __SE_CAPTURE.ensureSize(__SE_CAPTURE.final, outW, finalH);
  __SE_CAPTURE.ctxFinal.clearRect(0,0,outW,finalH);
  __SE_CAPTURE.ctxFinal.drawImage(__SE_CAPTURE.scaled, 0,0,outW,finalH, 0,0,outW,finalH);

  applyGrayscaleContrast(__SE_CAPTURE.final, __SE_CAPTURE.ctxFinal);

  if (burnInWatermark) drawWatermarkOnCanvas(__SE_CAPTURE.ctxFinal, outW, finalH);

  return __SE_CAPTURE.final.toDataURL('image/jpeg', CAPTURE_JPEG_Q);
}

function captureImage() {
  if (!video) return;
  const ratios = getGuidelineCropRatios();
  if (!ratios) return;

  const vw=video.videoWidth||0, vh=video.videoHeight||0;
  if (vw<2 || vh<2) return;

  const cleanDataUrl = buildFinalImageFromSourceCrop(() => {
    const sx=Math.round(vw*ratios.left);
    const sy=Math.round(vh*ratios.top);
    const sw=Math.round(vw*ratios.w);
    const sh=Math.round(vh*ratios.h);

    const safeSW=Math.max(1, Math.min(sw, vw-sx));
    const safeSH=Math.max(1, Math.min(sh, vh-sy));

    const outW=Math.min(CAPTURE_MAX_W, safeSW);
    const scale=outW/safeSW;
    const outH=Math.max(1, Math.round(safeSH*scale));

    __SE_CAPTURE.ensureSize(__SE_CAPTURE.scaled, outW, outH);
    __SE_CAPTURE.ctxScaled.clearRect(0,0,outW,outH);
    __SE_CAPTURE.ctxScaled.drawImage(video, sx,sy,safeSW,safeSH, 0,0,outW,outH);

    return {outW, outH};
  }, { burnInWatermark:false });

  if (!cleanDataUrl) return;

  const watermarkedDataUrl = (() => {
    const w=__SE_CAPTURE.final.width, h=__SE_CAPTURE.final.height;
    drawWatermarkOnCanvas(__SE_CAPTURE.ctxFinal, w, h);
    return __SE_CAPTURE.final.toDataURL('image/jpeg', CAPTURE_JPEG_Q);
  })();

  if (watermarkOverlay) watermarkOverlay.style.display = '';
  setPreviewOnly(cleanDataUrl);
  __SE_OCR_PHOTO = cleanDataUrl;
  __SE_SUBMIT_PHOTO = (watermarkedDataUrl && watermarkedDataUrl.startsWith("data:image")) ? watermarkedDataUrl : "";

  closeCameraModal();
}

// Preview sizing
function adjustPreviewSize() {
  const container=document.getElementById('imageContainer');
  if (!container) return;
  const width = container.clientWidth || window.innerWidth || document.documentElement.clientWidth;
  container.style.maxHeight = Math.round(width * PREVIEW_MAX_RATIO) + "px";
}
window.addEventListener('load', adjustPreviewSize);
window.addEventListener('resize', adjustPreviewSize);

// Phone call
function updateCallLink() {
  const contactEl=document.getElementById('contact');
  const callBtn=document.getElementById('callBtn');
  if (!contactEl || !callBtn) return;

  const digits=(contactEl.value||"").replace(/[^0-9]/g,"");
  if (digits && digits.length < 10) contactEl.setCustomValidity('Minimum 10 digit required');
  else contactEl.setCustomValidity('');

  if (digits.length >= 10) {
    callBtn.href='tel:'+digits;
    callBtn.style.display='flex';
  } else {
    callBtn.style.display='none';
  }
}
(function(){
  const __callBtn = document.getElementById('callBtn');
  if (!__callBtn) return;
  __callBtn.addEventListener('click', function(e) {
  const digits=(document.getElementById('contact').value||"").replace(/[^0-9]/g,"");
  if (digits.length < 10) e.preventDefault();
});
})();

// Warmup like secure entry
document.addEventListener("DOMContentLoaded", () => {
  if (!sessionStorage.getItem("SE_WARMED")) {
    fetch(WORKER_URL + "?debug=1", { cache: "no-store" }).catch(() => {});
    fetch(WORKER_URL + "?ping=1", { cache: "no-store" }).catch(() => {});
    setTimeout(() => fetch(WORKER_URL + "?ping=2", { cache: "no-store" }).catch(() => {}), 800);
    sessionStorage.setItem("SE_WARMED", "1");
  }
});

// Search same logic
function detectSearchField(raw) {
  const s=(raw||"").trim().toUpperCase();
  const digitsOnly=s.replace(/[^0-9]/g,"");
  const alnumOnly=s.replace(/[^A-Z0-9]/g,"");

  if (digitsOnly.length===12 && !/[A-Z]/.test(alnumOnly)) return FIELD.ID;
  if (/^\d{6}-\d{2}-\d{4}$/.test(s)) return FIELD.ID;

  if (/^[A-Z]{1,3}\d{6,}[A-Z]{3}$/.test(alnumOnly)) return FIELD.ID;
  if (/^[A-Z]{1,3}\d{6,}$/.test(alnumOnly)) return FIELD.ID;

  if (/^[A-Z]{1,3}\d{4}[A-Z]?$/.test(alnumOnly)) return FIELD.REG;
  return "";
}

async function searchRecord(field, value) {
  const url = `${WORKER_URL}?field=${encodeURIComponent(field)}&value=${encodeURIComponent(value)}`;
  const controller=new AbortController();
  const timeoutId=setTimeout(()=>controller.abort(), 9000);

  try {
    const res=await fetch(url, { cache:"no-store", keepalive:true, signal: controller.signal });
    if (!res.ok) {
      const msg=await res.text().catch(()=> "");
      throw new Error(`Search failed (${res.status}): ${msg || res.statusText}`);
    }
    return await res.json();
  } finally {
    clearTimeout(timeoutId);
  }
}

async function handleUniversalSearch() {
  const btn=document.getElementById('searchButton');
  const inputEl=document.getElementById('searchUniversal');
  const input=(inputEl?.value||"").trim();
  if (!input) return;

  const valueNorm=normalize(input);
  const detectedField=detectSearchField(input);

  btn.disabled=true;
  btn.innerHTML='<span class="loader"></span> SEARCHING...';

  try {
    let found=null;
    let res;

    if (detectedField) {
      res=await searchRecord(detectedField, valueNorm);
      if (res && res.exist) { found=res.data||null; }
    }

    if (!found && !detectedField) {
      const guessField=(/[A-Z]/.test(valueNorm) ? FIELD.REG : FIELD.ID);
      res=await searchRecord(guessField, valueNorm);
      if (res && res.exist) { found=res.data||null; }
    }

    if (found) {
      safeSwalFire({
        title:'RECORD FOUND',
        text:'Autofill this form with record details?',
        icon:'success',
        showCancelButton:true,
        confirmButtonText:'YES',
        cancelButtonText:'NO',
        background:'linear-gradient(135deg, #e9f7ef 0%, #c8efd9 45%, #9fdfbf 100%)',
        color:'#176B39',
        width:300
      }).then((r)=>{
        if (r.isConfirmed) {
          // minimal autofill if backend supports
          if (found.namePassport) document.getElementById('namePassport').value = normUpper(found.namePassport);
          if (found.mykadPassport) {
            const icEl=document.getElementById('mykadPassport');
            icEl.value=normUpper(found.mykadPassport);
            icEl.dispatchEvent(new Event('input'));
          }
          if (found.regnum) document.getElementById('regnum').value = normUpper(found.regnum);
          if (found.contact) { document.getElementById('contact').value = found.contact; updateCallLink(); }
          if (found.workLocation) document.getElementById('workLocation').value = normUpper(found.workLocation);
          if (found.jobDescription) document.getElementById('jobDescription').value = normUpper(found.jobDescription);
        }
        inputEl.value="";
      });
    } else {
      safeSwalFire({
        title:'NO PREVIOUS RECORD',
        text:'Please proceed to register',
        icon:'warning',
        showCancelButton:false,
        confirmButtonText:'OK',
        background:'linear-gradient(135deg, #e1f5fe 0%, #b3e5fc 45%, #81d4fa 100%)',
        color:'#176B39',
        width:300
      }).then(()=> inputEl.value="");
    }
  } catch(err) {
    safeSwalFire({ title:'ERROR', text: err?.message || 'Please try again', icon:'error', confirmButtonText:'OK' });
  } finally {
    btn.disabled=false;
    btn.innerHTML='SEARCH';
  }
}

// Submit + checkout
let __SE_isSubmitting=false;

function buildPayloadBase(){
  let company=companySelect.value;
  const companyOtherVal=normUpper(companyOther.value);
  if (company==="OTHER" && companyOtherVal) company = `OTHER ( ${companyOtherVal} )`;

  let techCat=techCatSelect.value;
  const techOtherVal=normUpper(techCatOther.value);
  if (techCat==="OTHER" && techOtherVal) techCat = `OTHER ( ${techOtherVal} )`;

  return {
    module: "TECHNICIAN_VENDOR",
    company,
    techCategory: techCat,
    namePassport: normUpper(document.getElementById('namePassport').value),
    mykadPassport: normUpper(document.getElementById('mykadPassport').value),
    regnum: normUpper(document.getElementById('regnum').value),
    contact: (document.getElementById('contact').value||"").trim(),
    workLocation: normUpper(document.getElementById('workLocation').value),
    jobDescription: normUpper(document.getElementById('jobDescription').value),
    imageUrl: (__SE_SUBMIT_PHOTO || "")
  };
}

function resetAfterSuccess(){
  document.getElementById("registrationForm").reset();
  const callBtn=document.getElementById('callBtn');
  if (callBtn) { callBtn.style.display='none'; callBtn.removeAttribute('href'); }
  if (previewImg) previewImg.src="#";
  if (imageContainer) imageContainer.style.display='none';
  __SE_SUBMIT_PHOTO=""; __SE_OCR_PHOTO="";
  if (watermarkOverlay) watermarkOverlay.style.display='';
  __TV_RECORD_ID="";
  checkoutBtn.disabled=true;
  statusSelect.disabled = true;
  statusSelect.required = false;
  statusSelect.value = "";
  if (statusSpecify){ statusSpecify.value=""; statusSpecify.style.display="none"; statusSpecify.required=false; }
  syncOthersLogic();
}

document.getElementById("registrationForm").addEventListener("submit", async function(e){
  e.preventDefault();

  validateMykadPassport();
  updateCallLink();

  if (!this.checkValidity()) {
    this.reportValidity();
    return;
  }

  if (__SE_isSubmitting) return;
  __SE_isSubmitting=true;
  setSubmitBtnLoading(true);

  const payload = buildPayloadBase();
  payload.action="submit";
  payload.timeIn=nowStamp();
  payload.status="IN PROGRESS";

  const controller=new AbortController();
  const timeoutId=setTimeout(()=>controller.abort(), 20000);

  try {
    const res=await fetch(WORKER_URL, {
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify(payload),
      cache:"no-store",
      keepalive:true,
      signal: controller.signal
    });

    if (!res.ok) {
      const t=await res.text().catch(()=> "");
      throw new Error(`HTTP ${res.status} ${res.statusText}${t ? " - " + t.slice(0,200) : ""}`);
    }

    const ct=(res.headers.get("content-type")||"").toLowerCase();
    const resp = ct.includes("application/json") ? await res.json() : { success:true, message:"OK" };

    if (resp && resp.success) {
      __TV_RECORD_ID = resp.recordId || resp.record_id || resp.id || "";
      checkoutBtn.disabled = !__TV_RECORD_ID;

      safeSwalFire({
        title:'SUCCESS!',
        text:'Entry submitted. Use CHECK OUT when job completed.',
        icon:'success',
        confirmButtonText:'OK',
        width:300,
        background:'linear-gradient(135deg,#e9f5e9,#fff,#d5ffe0)',
        color:'#176B39',
        timer:4500,
        timerProgressBar:true
      });
    } else {
      safeSwalFire({
        title:'ERROR!',
        text:'Submit failed: ' + (resp?.message || ''),
        icon:'error',
        confirmButtonText:'OK'
      });
    }
  } catch(err) {
    safeSwalFire({ title:'ERROR!', text:'Error submit data: ' + err.message, icon:'error', confirmButtonText:'OK' });
  } finally {
    clearTimeout(timeoutId);
    setSubmitBtnLoading(false);
    __SE_isSubmitting=false;
  }
});

checkoutBtn.addEventListener("click", async ()=>{
  if (!__TV_RECORD_ID) {
    safeSwalFire({ title:'NOTICE', text:'Please SUBMIT entry first.', icon:'info', confirmButtonText:'OK', width:300 });
    return;
  }

  statusSelect.disabled = false;
  statusSelect.required = true;
  syncStatusSpecify();

  if (!statusSelect.value) {
    statusSelect.focus();
    safeSwalFire({ title:'STATUS REQUIRED', text:'Please select a job status before CHECK OUT.', icon:'warning', confirmButtonText:'OK', width:300 });
    return;
  }


  // If "RETURN REQUIRED", require specify
  if (statusSelect.value === "RETURN REQUIRED") {
    const spec = normUpper(statusSpecify ? statusSpecify.value : "");
    if (!spec) {
      if (statusSpecify) statusSpecify.focus();
      safeSwalFire({
        title:'PLEASE SPECIFY',
        text:'Please specify when a return visit is required.',
        icon:'warning',
        confirmButtonText:'OK',
        width:300
      });
      return;
    }
  }


  const confirm = await safeSwalFire({
    title:'CONFIRM CHECKOUT',
    text:`Checkout with status: ${statusSelect.value}${statusSelect.value==="RETURN REQUIRED" ? " (" + (statusSpecify ? statusSpecify.value : "") + ")" : ""} ?`,
    icon:'question',
    showCancelButton:true,
    confirmButtonText:'YES',
    cancelButtonText:'NO',
    width:300,
    background:'linear-gradient(135deg, #e9f7ef 0%, #c8efd9 45%, #9fdfbf 100%)',
    color:'#176B39'
  });

  if (!confirm.isConfirmed) return;

  if (__SE_isSubmitting) return;
  __SE_isSubmitting=true;
  setCheckoutBtnLoading(true);

  const payload={
    action:"checkout",
    module:"TECHNICIAN_VENDOR",
    recordId: __TV_RECORD_ID,
    status: statusSelect.value,
    statusSpecify: normUpper(statusSpecify ? statusSpecify.value : ""),
    timeOut: nowStamp()
  };

  const controller=new AbortController();
  const timeoutId=setTimeout(()=>controller.abort(), 20000);

  try {
    const res=await fetch(WORKER_URL, {
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify(payload),
      cache:"no-store",
      keepalive:true,
      signal: controller.signal
    });

    if (!res.ok) {
      const t=await res.text().catch(()=> "");
      throw new Error(`HTTP ${res.status} ${res.statusText}${t ? " - " + t.slice(0,200) : ""}`);
    }

    const ct=(res.headers.get("content-type")||"").toLowerCase();
    const resp = ct.includes("application/json") ? await res.json() : { success:true, message:"OK" };

    if (resp && resp.success) {
      safeSwalFire({ title:'CHECKOUT DONE', text:'Record updated successfully.', icon:'success', confirmButtonText:'OK', width:300, timer:4500, timerProgressBar:true });
      resetAfterSuccess();
    } else {
      safeSwalFire({ title:'ERROR!', text:'Checkout failed: ' + (resp?.message || ''), icon:'error', confirmButtonText:'OK' });
    }
  } catch(err) {
    safeSwalFire({ title:'ERROR!', text:'Error checkout: ' + err.message, icon:'error', confirmButtonText:'OK' });
  } finally {
    clearTimeout(timeoutId);
    setCheckoutBtnLoading(false);
    __SE_isSubmitting=false;
  }
});

// Clock
function pad(n){return n<10?'0'+n:n;}
function updateDateTime() {
  const now = new Date();
  document.getElementById("liveDateOnly").textContent = `${pad(now.getDate())}/${pad(now.getMonth()+1)}/${now.getFullYear()}`;
  document.getElementById("liveTimeOnly").textContent = `${pad(now.getHours())}:${pad(now.getMinutes())}:${pad(now.getSeconds())}`;
}
setInterval(updateDateTime, 1000);
updateDateTime();

// Header offset
function syncHeaderOffset() {
  const header = document.querySelector('.fixed-header');
  if (!header) return;
  document.body.style.paddingTop = (header.offsetHeight + 0) + 'px';
}
window.addEventListener('load', syncHeaderOffset);
window.addEventListener('resize', syncHeaderOffset);
    </script>
  </body>
</html>
